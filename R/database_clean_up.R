library(dplyr)
library(stringr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(vegan)
library(tidyr)
library(viridis)
library(measurements)
library(PBSmapping)
library(cowplot)
library(taxize)
library(purrr)

tbl_PlantSpecies <-read.csv("raw_data/tbl_PlantSpecies.csv")

tblLocation<-read.csv("raw_data/tblLocation.csv")

tblMainBee <-read.csv("raw_data/tblMainBee.csv")

tblNames_Species <-read.csv("raw_data/tblNames_Species.csv")

##### fixing locations coordinates ######

origin_dd <- tblLocation %>% 
  select(New.LocID, DecimalLat, DecimalLon) %>% 
  extract(DecimalLat, into = "decimal_lat", regex = "(\\d+\\.\\d+)") %>% 
  extract(DecimalLon, into = "decimal_lon", regex = "(\\-\\d+\\.\\d+)") %>% 
  filter(!is.na(decimal_lat)) %>% 
  mutate(decimal_lat = as.numeric(decimal_lat), decimal_lon = as.numeric(decimal_lon))

degree_to_decimal <- tblLocation %>%
  select(New.LocID, Degree.Lat, Degree.Lon) %>% 
  filter(!(New.LocID %in% origin_dd$New.LocID)) %>% 
  extract(Degree.Lat, into = "deg_lat", regex = "(\\d+)", remove = FALSE) %>% 
  extract(Degree.Lat, into = "min_lat", regex = "(\\°\\s*\\d+)", remove = FALSE) %>% 
  extract(min_lat, into = "min_lat", regex = "(\\d+)") %>% 
  extract(Degree.Lat, into = "sec_lat", regex = "([\\'|\\’]\\s*\\d+\\.*\\d+)") %>% 
  extract(sec_lat, into = "sec_lat", regex = "(\\d+\\.*\\d+)") %>% 
  mutate(deg_min_sec_lat = paste(deg_lat, min_lat, sec_lat)) %>% 
  mutate(decimal_lat = conv_unit(deg_min_sec_lat, from = 'deg_min_sec', to = 'dec_deg')) %>% 
  extract(Degree.Lon, into = "deg_lon", regex = "(\\d+)", remove = FALSE) %>% 
  extract(Degree.Lon, into = "min_lon", regex = "(\\°\\s*\\d+)", remove = FALSE) %>% 
  extract(min_lon, into = "min_lon", regex = "(\\d+)") %>% 
  extract(Degree.Lon, into = "sec_lon", regex = "([\\'|\\’]\\s*\\d+\\.*\\d+)") %>% 
  extract(sec_lon, into = "sec_lon", regex = "(\\d+\\.*\\d+)") %>% 
  mutate(deg_min_sec_lon = paste(deg_lon, min_lon, sec_lon)) %>% 
  mutate(decimal_lon = conv_unit(deg_min_sec_lon, from = 'deg_min_sec', to = 'dec_deg')) %>% 
  select(New.LocID, decimal_lat, decimal_lon) %>% 
  filter(!is.na(decimal_lat)) %>% 
  mutate(decimal_lat = as.numeric(decimal_lat), decimal_lon = -1*as.numeric(decimal_lon)) 

utm_orgin <- tblLocation %>%
  select(New.LocID, UTMEW, UTMNS) %>% 
  filter(!is.na(UTMEW))

utm_tab <- tblLocation %>% 
  select(UTMEW, UTMNS) %>% 
  filter(!is.na(UTMEW)) %>% 
  mutate(UTMEW = as.numeric(UTMEW)) %>% 
  mutate(UTMNS = as.numeric(UTMNS)) %>% 
  rename(X = UTMEW, Y = UTMNS)

attr(utm_tab, "zone") <- 10
attr(utm_tab, "projection") <- "UTM"
utm_to_dec <- convUL(utm_tab, km=FALSE, southern=NULL)

utm_to_decimal_final <- cbind(utm_orgin, utm_to_dec) %>% 
  rename(decimal_lat = Y, decimal_lon = X) %>% 
  select(New.LocID, decimal_lat, decimal_lon) %>% 
  mutate(decimal_lat = as.numeric(decimal_lat), decimal_lon = as.numeric(decimal_lon)) 

final_locations <- bind_rows(origin_dd, utm_to_decimal_final, degree_to_decimal)

##### locations#######


#### plant bee table

plant_bee_table <- tblMainBee %>%
  select(BeeID, New.LocID = NewLocID, Yr0, SpID, PlantSpeciesID = FlorNum) %>% 
  filter(!is.na(PlantSpeciesID)) %>% 
  filter(!is.na(BeeID)) %>% 
  left_join(select(tblNames_Species, SpID, GenusName, Species, BeeGenusID)) %>% 
  filter(!is.na(BeeGenusID)) %>% 
  left_join(tbl_PlantSpecies) %>% 
  left_join(final_locations) %>% 
  left_join(select(tblLocation, New.LocID, Location_Desc))

write.csv(plant_bee_table, "data/site_net.csv", row.names = FALSE)

########### location names #######

db <- read.csv("data/site_net.csv", stringsAsFactors = FALSE)

regions <- read.csv("data/new_regions.csv")

db_lo <- db %>% 
  left_join(regions)

write.csv(db_lo, "data/site_net_locs.csv", row.names = FALSE)


################ making sure it is species ########

## filter species that have less than 1 obsevation for plants and less than 5 observations for bees

db <- read.csv("data/site_net_locs.csv", stringsAsFactors = FALSE)

bee_traits <- read.csv("raw_data/elle_insects.csv", stringsAsFactors = FALSE)

plant_traits <- read.csv("raw_data/elle_plants_full/elle_plants_full-Table 1.csv", stringsAsFactors = FALSE) %>% 
  filter(!plant_sp == "Incidental Collection") %>% 
  filter(!plant_sp == "Miscellaneous white flower") %>% 
  filter(!plant_sp == "Mixed species") %>% 
  filter(!str_detect(plant_sp, "Nest")) %>% 
  filter(!plant_sp == "net") %>% 
  mutate(plant_sp = ifelse(plant_sp == "Spirea douglasii ssp. Douglasii", "Spiraea douglasii", plant_sp)) %>% 
  mutate(plant_sp = ifelse(plant_sp == "Symphoricarpus albus", "Symphoricarpos albus", plant_sp)) %>% 
  mutate(plant_sp = ifelse(plant_sp == "Syringia", "Syringa", plant_sp)) %>% 
  mutate(plant_sp = ifelse(plant_sp == "Alyssum", "Lobularia", plant_sp)) %>% 
  mutate(plant_sp = ifelse(plant_sp == "Convulvulus arvensis", "Convolvulus arvensis", plant_sp)) %>% 
  mutate(plant_sp = ifelse(plant_sp == "Craetagus douglasii", "Crataegus douglasii", plant_sp)) 

bee_names <- read.csv("raw_data/common_names_pol.csv", stringsAsFactors = FALSE)

plant_names <- read.csv("raw_data/common_names_plants.csv", stringsAsFactors = FALSE)

db_int <- db %>% 
  filter(!(Species == "")) %>% 
  filter(!str_detect(Species, "sp.")) %>% 
  unite(col = "bee_sp", GenusName, Species, sep = " ") %>% 
  dplyr::rename(plant_sp = Species.Name) %>% 
  filter(!bee_sp == "Hemiptera misc.") %>% 
  filter(!plant_sp == "Incidental Collection") %>% 
  filter(!plant_sp == "Miscellaneous white flower") %>% 
  filter(!plant_sp == "Mixed species") %>% 
  filter(!str_detect(plant_sp, "Nest")) %>% 
  filter(!plant_sp == "net") %>% 
  mutate(plant_sp = ifelse(plant_sp == "Spirea douglasii ssp. Douglasii", "Spiraea douglasii", plant_sp)) %>% 
  mutate(plant_sp = ifelse(plant_sp == "Symphoricarpus albus", "Symphoricarpos albus", plant_sp)) %>% 
  mutate(plant_sp = ifelse(plant_sp == "Syringia", "Syringa", plant_sp)) %>% 
  mutate(plant_sp = ifelse(plant_sp == "Alyssum", "Lobularia", plant_sp)) %>% 
  mutate(plant_sp = ifelse(plant_sp == "Convulvulus arvensis", "Convolvulus arvensis", plant_sp)) %>% 
  mutate(plant_sp = ifelse(plant_sp == "Craetagus douglasii", "Crataegus douglasii", plant_sp)) 

bees_great <- db_int %>% 
  group_by(bee_sp) %>% 
  dplyr::summarise(n = n()) %>% 
  filter(n >5)

bee_name_clean <- bees_great %>% 
  mutate(bee_gen = str_extract(bee_sp, "\\w+")) %>% 
  left_join(bee_names, by = c("bee_gen" = "Genus")) %>% 
  left_join(select(bee_traits, insect_sp, insect_order, social, nest_location, larval_diet, insect_guild),
            by = c("bee_sp" = "insect_sp")) %>% 
  dplyr::select(-n, -bee_gen) %>% 
  dplyr::rename(bee_common = Common.name, bee_order = insect_order, bee_social = social, bee_nest_location = nest_location,
         bee_diet = larval_diet, bee_guild = insect_guild)

plant_great <- db_int %>% 
  group_by(plant_sp) %>% 
  dplyr::summarise(n = n()) %>% 
  filter(n >5)

plant_name_clean <- plant_great %>% 
  mutate(plant_gen = str_extract(plant_sp, "\\w+")) %>% 
  left_join(plant_names, by = c("plant_gen" = "plant_sp")) %>% 
  left_join(plant_traits, by = c("plant_sp")) %>%
  dplyr::select(plant_sp, plant_common = common.name, plant_order, plant_family, plant_native = native_inv, 
         plant_life_form = Life.form) 


db2 <- db_int %>% 
  filter(bee_sp %in% bees_great$bee_sp) %>% 
  filter(plant_sp %in% plant_great$plant_sp) %>% 
  left_join(bee_name_clean) %>% 
  left_join(plant_name_clean) %>% 
  select(-BeeID, -SpID, -PlantSpeciesID, -BeeGenusID, -Species.CODE) %>% 
  mutate(plant_sp = str_replace(plant_sp, " ", "\n"), bee_sp = str_replace(bee_sp, " ", "\n")) %>% 
  mutate(plant_native = ifelse(plant_native == "native*", "non-native", plant_native)) %>% 
  mutate(plant_native =ifelse(is.na(plant_native), 'both', plant_native)) %>% 
  mutate(plant_life_form = str_to_sentence(plant_life_form)) %>% 
  mutate(plant_life_form = ifelse(plant_life_form == "Woody vine", "Vine", plant_life_form)) %>% 
  mutate(plant_life_form = ifelse(plant_life_form == "Varies", "Various", plant_life_form)) %>% 
  mutate(plant_life_form = ifelse(plant_life_form == "Shrub or tree", "Shrub", plant_life_form)) %>% 
  mutate(plant_life_form = ifelse(plant_life_form == "Herb to shrub", "Shrub", plant_life_form)) %>% 
  mutate(plant_life_form =ifelse(is.na(plant_life_form), 'Herb', plant_life_form))


write.csv(db2, "data/site_net_loc_fil.csv", row.names = FALSE)


##### check native 

